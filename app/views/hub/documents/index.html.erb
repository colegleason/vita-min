<%= content_for :back_to, "clients" %>
<% content_for :page_title, "#{@client.preferred_name} ##{@client.id} documents" %>

<% content_for :card do %>
  <%= render "hub/clients/client_header" %>

  <%= render "hub/clients/navigation" %>

  <div class="document-view-switcher">
    <span>View:</span>
    <%= link_to "javascript:listView()", class: "button button--small button--primary list-button" do %>
      <i class="icon icon-">&#xe8ef;</i> List
    <% end %>
    <%= link_to "javascript:galleryView()", class: "button button--small gallery-button" do %>
      <i class="icon icon-">&#xe8f0;</i> Gallery
    <% end %>
  </div>

  <table class="data-table">
    <thead>
    <tr>
      <th scope="col" class="document-column__doc-type">
        <%= render "shared/column_sort_link", title: t("general.document_type"), column_name: "document_type" %>
      </th>
      <th scope="col" class="document-column__link">
        <%= render "shared/column_sort_link", title: t(".file_name"), column_name: "display_name" %>
      </th>
      <th class="document-column__link">
        <%= render "shared/column_sort_link", title: t("general.tax_return"), column_name: "tax_return" %>
      </th>
      <th scope="col" class="document-column__upload-date">
        <%= render "shared/column_sort_link", title: t(".upload_date"), column_name: "created_at" %>
      </th>
      <th></th>
    </tr>
    </thead>
    <tbody>
    <% if @documents.present? %>
      <% @documents.each do |document| %>
        <tr id="document-<%= document.id %>">
          <td><%= document.document_type_label %></td>
          <td>
            <%= link_to hub_client_document_path(client_id: @client.id, id: document.id), target: "_blank", rel: "noopener noreferrer" do %>
              <%= document.display_name %> <%= t(".empty_file") if document.upload.blob.byte_size.zero? %>
            <% end %>
          </td>
          <td>
            <%= document.tax_return&.year %>
          </td>
          <td><%= long_formatted_datetime document.created_at %></td>
          <td class="edit">
            <%= link_to t("general.edit"), edit_hub_client_document_path(client_id: @client.id, id: document.id) %>
          </td>
        </tr>
      <% end %>
    <% end %>
    </tbody>
  </table>

  <% if @documents.present? %>
  <div class="document-gallery-view">
      <% @documents.each do |document| %>
        <div class="document-card" id="document-<%= document.id %>">
          <div class="document-preview">
            <%= image_tag hub_client_document_path(client_id: @client.id, id: document.id), alt: "" %>
          </div>
          <div class="tool-container">
            <button class='button--small' title="View">
            <%= link_to hub_client_document_path(client_id: @client.id, id: document.id), target: "_blank", rel: "noopener noreferrer" do %>
              Open
            <% end %>
          </button>
            <button onclick="rotateImage(this)" class="button--small" title="Rotate">&#8635;</button>
            <button onclick="flipImage(this)" class="button--small" title="Flip">&#8646;</button>
        </div>
        <div class="document-edit-form-inline">
          <%= form_with(model: @document, url: [:hub, @client, document], method: "patch", local: false, builder: VitaMinFormBuilder) do |f| %>
            <%= f.vita_min_text_field "display_name", t('hub.documents.display_name'), classes: ["form-width--long"], options: {value:document.display_name} %>
            <%= f.cfa_select "document_type", t("general.document_type"), DocumentTypes::ALL_TYPES.map { |doc_type| [doc_type.label, doc_type.key] }, include_blank: true, selected: document.document_type %>
            <%= f.cfa_select :tax_return_id, t("general.tax_return"), @client.tax_returns.map { |tax_return| [tax_return.year, tax_return.id] }, include_blank: true, selected: document.tax_return.id  %>
            <button class="button button--cta" type="submit">
              <%= t("general.save") %>
            </button>
          <% end %>
        </div>
        </div>
        <% end %>
    </div>
    <% end %>

  <%= link_to t(".add_client_envelope_doc"), new_hub_client_document_path, class: "button" %>

  <%= form_with model: @document, url: [:hub, @client, :documents], local: true, method: "post", builder: VitaMinFormBuilder, id: "file-upload-form" do |f| %>
    <div class="document-upload">
      <div class="file-upload">
        <%= f.file_field(:upload, multiple: "multiple", class: "form__documentuploader file-input", data: { "upload-immediately" => true}) %>
        <%= f.label(:upload, class: "button button--wide button--icon js-only", style: "display: none !important;") do %>
          <span class="is-tablet-hidden--inline">
            <%= image_tag "upload.svg", alt: "" %>
            <%=t("general.select_files") %>
          </span>
          <span class="is-desktop-hidden--inline">
            <%= image_tag "camera.svg", alt: "" %>
            <%=t("general.take_picture") %>
          </span>
        <% end %>
      </div>
    </div>

    <% if @document.errors[:upload].any? %>
      <div class="form-group form-group--error">
        <% @document.errors.values.flatten.each do |error_message| %>
          <p class="text--error"><i class="icon-warning"></i>
            <%= error_message %>
          </p>
        <% end %>
      </div>
    <% end %>

    <%= f.button class: "button button--primary button--wide" do %>
      <%=t("general.upload") %>
    <% end %>
  <% end %>


  <%= render "hub/clients/client_take_action_footer" %>
  <script type="text/javascript" src="https://mozilla.github.io/pdf.js/build/pdf.js" />
<% end %>
